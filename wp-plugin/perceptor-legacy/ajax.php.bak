<?php
declare(strict_types=1);
if (!defined('ABSPATH')) exit;

/** Admin-AJAX: enqueue capture job */
add_action('wp_ajax_perceptor_enqueue', function () {
  if (!current_user_can('manage_options')) wp_send_json_error(['code'=>'cap'], 403);
  $nonce = $_POST['nonce'] ?? '';
  if (!wp_verify_nonce($nonce, 'perceptor_ajax')) wp_send_json_error(['code'=>'nonce'], 403);

  $type = sanitize_text_field($_POST['type'] ?? '');
  $camera = sanitize_text_field($_POST['camera'] ?? '');
  $duration = intval($_POST['duration'] ?? 0);
  if ($type !== 'capture' || !$camera || $duration <= 0) wp_send_json_error(['code'=>'bad'], 400);

  $q = get_option('perceptor_jobs', []);
  if (!is_array($q)) $q = [];
  $job = ['id'=>uniqid('job_', true), 'type'=>'capture', 'camera'=>$camera, 'duration'=>$duration, 'ts'=>time()];
  $q[] = $job;
  update_option('perceptor_jobs', $q, false);

  wp_send_json_success(['job'=>$job]);
});
